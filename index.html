<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Repositório de Notícias — Hedgepoint</title>

<!-- Montserrat -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --hp-orange:#ED8B00; --hp-blue:#272259; --hp-black:#000000; --hp-white:#FFFFFF;
    --hp-off:#F8F9F7; --hp-gray:#4D4C4D; --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--hp-off);color:var(--hp-black);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
  a{color:inherit}
  .wrap{max-width:1100px;margin:48px auto;padding:0 20px;}
  h1{font-weight:700;font-size:28px;margin:0 0 8px;}
  .sub{color:var(--hp-gray);margin:0 0 24px;font-size:14px;}

  .controls{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;margin:0 0 20px;}
  .control{display:flex;flex-direction:column;gap:6px;}
  .control label{font-size:12px;color:var(--hp-gray)}
  .control select,.control input{border:1px solid #ddd;border-radius:10px;padding:10px 12px;background:#fff;font:inherit;outline:none;}
  .btn{border-radius:999px;padding:10px 16px;background:var(--hp-black);color:#fff;border:none;cursor:pointer;font-weight:700;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}

  #container{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  @media (max-width:980px){#container{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:640px){#container{grid-template-columns:1fr;}}

  .card{background:#fff;border:1px solid #eee;border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;display:flex;flex-direction:column;gap:10px;}
  .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .badge{font-weight:700;font-size:12px;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;letter-spacing:.2px;}
  .badge--nacional{background:var(--hp-orange);color:#fff;}
  .badge--internacional{background:var(--hp-blue);color:#fff;}
  .date{font-size:12px;color:var(--hp-gray)}
  .title-wrap{display:flex;flex-direction:column;gap:6px;}
  .title{font-weight:700;font-size:18px;line-height:1.25;margin:0;}
  .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#fff;background:var(--hp-black);padding:6px 10px;border-radius:999px;width:max-content;}
  .tag[hidden]{display:none}
  .vehicle{display:flex;align-items:center;gap:10px;margin-top:2px;}
  .vehicle img{width:22px;height:22px;border-radius:50%;border:1px solid #eee;object-fit:cover;background:#fff;}
  .vehicle span{font-size:12px;color:var(--hp-gray)}
  .cta{display:flex;justify-content:flex-end;margin-top:auto;}
  .button-link{border:2px solid var(--hp-black);color:var(--hp-black);background:#fff;padding:8px 14px;border-radius:999px;font-weight:700;text-decoration:none;transition:transform .06s ease;}
  .button-link:hover{transform:translateY(-1px);}
  .list-footer{display:flex;justify-content:center;margin:24px 0 8px;}
  .empty{padding:28px;text-align:center;color:var(--hp-gray)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Repositório de Notícias</h1>
    <p id="statsLine" class="sub">Carregando…</p>

    <div class="controls" role="region" aria-label="Filtros">
      <div class="control">
        <label for="escopo">Escopo</label>
        <select id="escopo">
          <option value="">Todos</option>
          <option value="Nacional">Nacional</option>
          <option value="Internacional">Internacional</option>
        </select>
      </div>
      <div class="control" id="commodityControl" hidden>
        <label for="commodity">Commodity</label>
        <select id="commodity">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="control">
        <label for="search">Busca por título</label>
        <input id="search" type="search" placeholder="Digite parte do título…">
      </div>
      <button id="apply" class="btn">Aplicar filtros</button>
    </div>

    <div id="container"></div>
    <div class="list-footer">
      <button id="loadMore" class="btn">Carregar mais</button>
    </div>
    <div id="emptyState" class="empty" style="display:none">Nenhuma notícia encontrada com os filtros atuais.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  (function(){
    // CSV público
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Wkg0xuRA_RhRVfyS0azJ80LfzN9Ezm7Xg64J_ebTTm7S3LjmNI8BpqhjOJ-PzyjtCdCeEtfdaFSE/pub?output=csv';

    // Cabeçalhos (Commodity/Logo opcionais)
    const FIELD = {
      categoria:'Categoria',
      titulo:'Titulo',
      veiculo:'Veiculo',
      data:'DataPublicacao',
      url:'URL',
      escopo:'Escopo',
      commodity:'Commodity',
      logo:'Logo'
    };

    const PAGE_SIZE = 9;
    let master = [], view = [], page = 0, hasCommodity = false;

    const els = {
      container: document.getElementById('container'),
      loadMore: document.getElementById('loadMore'),
      empty: document.getElementById('emptyState'),
      escopo: document.getElementById('escopo'),
      commodity: document.getElementById('commodity'),
      commodityControl: document.getElementById('commodityControl'),
      search: document.getElementById('search'),
      apply: document.getElementById('apply'),
      stats: document.getElementById('statsLine')
    };

    // -------- Helpers
    function clean(s){
      return String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }
    const monthsPt = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

    // versão robusta: aceita ISO com/sem hora, e DD/MM/YYYY com/sem hora
    function parseDateFlexible(s){
      if(!s) return null;
      s = String(s).trim();

      let t = Date.parse(s);
      if(!isNaN(t)) return new Date(t);

      // remove hora/timezone e tenta
      let onlyDate = s.replace(/[T\s].*$/, '');
      t = Date.parse(onlyDate);
      if(!isNaN(t)) return new Date(t);

      // YYYY-MM-DD | YYYY/MM/DD | YYYY.MM.DD
      let m = onlyDate.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3]);

      // DD/MM/YYYY | DD-MM-YYYY
      m = onlyDate.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
      if(m){
        const y = m[3].length===2 ? +('20'+m[3]) : +m[3];
        return new Date(y, +m[2]-1, +m[1]);
      }
      return null;
    }
    function formatDatePt(d){ if(!(d instanceof Date)||isNaN(d)) return ''; const day=d.getDate(), mon=monthsPt[d.getMonth()], year=d.getFullYear(); return `${String(day).padStart(2,'0')} ${mon} ${year}`; }
    function byDateDesc(a,b){ return (b.__ts||0)-(a.__ts||0); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function plural(n,sing,plur){ return n===1?sing:plur; }

    function extractDomain(u){ try{ const {hostname}=new URL(u); return hostname.replace(/^www\./,''); }catch(_){ return ''; } }
    function logoForItem(item){
      if(item.logo) return item.logo.trim();
      const domain = extractDomain(item.url||'');
      if(domain) return `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(domain)}`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" fill="#ddd"/></svg>');
    }

    // -------- Normalização por linha
    function normalizeRow(r){
      const escRaw = (r[FIELD.escopo]||'');
      const escClean = clean(escRaw);
      let escNorm = '';
      if(escClean.startsWith('nac')) escNorm = 'nacional';
      else if(escClean.startsWith('int')) escNorm = 'internacional';

      const dt = parseDateFlexible(r[FIELD.data]||'');
      const commodityRaw = (r[FIELD.commodity]||'').trim();
      const commodityNorm = clean(commodityRaw);
      if(commodityRaw) hasCommodity = true;

      return {
        categoria:(r[FIELD.categoria]||'').trim(),
        titulo:(r[FIELD.titulo]||'').trim(),
        veiculo:(r[FIELD.veiculo]||'').trim(),
        data:(r[FIELD.data]||'').trim(),
        __date: dt?formatDatePt(dt):'',
        __ts: dt?dt.getTime():0,
        url:(r[FIELD.url]||'').trim(),
        escopo:(escRaw||'').trim(),  // exibição original
        __esc: escNorm,               // valor normalizado p/ filtro
        commodity: commodityRaw,      // exibição original
        __commodity: commodityNorm,   // valor normalizado p/ filtro
        logo:(r[FIELD.logo]||'').trim()
      };
    }

    // -------- Render
    function renderCard(item){
      const esc = (item.__esc||'');
      const badgeClass = esc === 'nacional' ? 'badge--nacional' : esc === 'internacional' ? 'badge--internacional' : '';
      const logoSrc = logoForItem(item);
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div class="top-row">
          <span class="badge ${badgeClass}">${escapeHtml(item.escopo||'—')}</span>
          <span class="date">${escapeHtml(item.__date || item.data || '—')}</span>
        </div>
        <div class="title-wrap">
          <h5 class="title">${escapeHtml(item.titulo||'Sem título')}</h5>
          <span class="tag"${hasCommodity && item.commodity ? '' : ' hidden'}>${escapeHtml(item.commodity||'')}</span>
        </div>
        <div class="vehicle">
          <img alt="" src="${logoSrc}" onerror="this.src='data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;64&quot; height=&quot;64&quot;><rect width=&quot;64&quot; height=&quot;64&quot; fill=&quot;#ddd&quot;/></svg>')}'">
          <span>${escapeHtml(item.veiculo||'')}</span>
        </div>
        <div class="cta">
          <a class="button-link" href="${encodeURI(item.url||'#')}" target="_blank" rel="noopener">Ver notícia</a>
        </div>`;
      return card;
    }

    function clearGrid(){ els.container.innerHTML=''; }
    function paintNextPage(){
      const start = page*PAGE_SIZE;
      const slice = view.slice(start, start+PAGE_SIZE);
      slice.forEach(i=>els.container.appendChild(renderCard(i)));
      page++;
      const hasMore = (page*PAGE_SIZE) < view.length;
      els.loadMore.style.display = hasMore ? '' : 'none';
      els.empty.style.display = view.length ? 'none' : '';
    }

    function dedupe(arr){ return [...new Set(arr)]; }
    function populateCommodityFilter(){
      if(!hasCommodity){
        els.commodityControl.hidden = true;
        return;
      }
      const values = master.map(r => r.commodity).filter(Boolean);
      const labels = dedupe(values).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      els.commodity.innerHTML = '<option value="">Todas</option>' +
        labels.map(lbl => `<option value="${escapeHtml(clean(lbl))}">${escapeHtml(lbl)}</option>`).join('');
      els.commodityControl.hidden = false;
    }

    function isFiltering(){
      const esc = clean(els.escopo.value);
      const com = hasCommodity ? clean(els.commodity.value) : '';
      const q   = clean(els.search.value);
      return !!(esc || com || q);
    }
    function updateStats(){
      const total = master.length, current = view.length;
      if(isFiltering()){
        els.stats.textContent = `Mostrando ${current} ${plural(current,'matéria','matérias')} de ${total} ${plural(total,'menção','menções')}.`;
      }else{
        els.stats.textContent = `Total de ${total} ${plural(total,'menção','menções')}.`;
      }
    }

    function applyFilters(){
      const escopoVal = clean(els.escopo.value);          // '' | 'nacional' | 'internacional'
      const commVal   = hasCommodity ? clean(els.commodity.value) : '';
      const q         = clean(els.search.value);

      view = master.filter(r=>{
        const okEsc = !escopoVal || r.__esc === escopoVal;
        const okCo  = !hasCommodity || !commVal || r.__commodity === commVal;
        const okQ   = !q || clean(r.titulo).includes(q);
        return okEsc && okCo && okQ;
      }).sort(byDateDesc);

      page=0; clearGrid(); paintNextPage(); updateStats();
    }

    els.apply.addEventListener('click', applyFilters);
    els.loadMore.addEventListener('click', paintNextPage);
    els.search.addEventListener('keydown', e=>{ if(e.key==='Enter') applyFilters(); });

    // -------- Boot
    function loadCSV(){
      if(!window.Papa){ els.stats.textContent='Erro: biblioteca de leitura (PapaParse) não carregou.'; return; }
      Papa.parse(CSV_URL, {
        download:true, header:true, skipEmptyLines:true,
        complete:(res)=>{
          try{
            hasCommodity = false;
            const rows = res.data || [];
            master = rows.map(normalizeRow).filter(r => r.titulo && r.url);
            master.sort(byDateDesc);
            populateCommodityFilter();
            applyFilters();
          }catch(err){
            console.error('Falha ao processar CSV:', err);
            showDemo('Falha ao processar CSV.');
          }
        },
        error:(err)=>{
          console.error('Erro CSV:', err);
          showDemo('Erro ao baixar o CSV publicado.');
        }
      });
    }

    function showDemo(reason){
      els.stats.textContent = (reason || 'Dados indisponíveis.') + ' Exibindo exemplos.';
      const demo = [
        {Titulo:'Exemplo 1',DataPublicacao:'2025-09-03',URL:'#',Escopo:'Nacional',Veiculo:'Demo'},
        {Titulo:'Exemplo 2',DataPublicacao:'2025-09-01',URL:'#',Escopo:'Internacional',Veiculo:'Demo'},
        {Titulo:'Exemplo 3',DataPublicacao:'2025-08-28',URL:'#',Escopo:'Nacional',Veiculo:'Demo'}
      ];
      hasCommodity = false;
      master = demo.map(normalizeRow);
      populateCommodityFilter();
      applyFilters();
    }

    window.addEventListener('load', loadCSV);
  })();
  </script>
</body>
</html>
