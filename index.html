<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hedgepoint News Feed</title>
  <meta name="description" content="Hedgepoint Global Markets – News feed powered by a published CSV.">
  <!-- Brand fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <!-- Brand CSS -->
  <style>
    :root{
      --hp-orange:#ED8B00;
      --hp-blue:#272259;
      --hp-black:#000000;
      --hp-white:#FFFFFF;
      --hp-offwhite:#F8F9F7;
      --hp-gray:#4D4C4D;
      --hp-darkgray:#222222;
      --hp-yellow:#FFC60A;
      --hp-aqua:#25B99B;
      --hp-green:#7ABF36;
      --hp-red:#E13C15;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--hp-offwhite);color:var(--hp-darkgray);font:16px/1.6 "Open Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .container{max-width:1100px;margin:0 auto;padding:32px 16px}
    header{background:var(--hp-blue);color:var(--hp-white);} 
    header .wrap{max-width:1100px;margin:0 auto;padding:20px 16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between} 
    h1{font-family:Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;font-weight:700;font-size:clamp(20px,3vw,28px);margin:0}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    input[type="search"], select, button, .tag{border:1px solid #d7d9df;background:#fff;color:var(--hp-darkgray);padding:10px 12px;border-radius:12px}
    input[type="search"]:focus, select:focus{outline:2px solid rgba(237,139,0,.35);border-color:var(--hp-orange)}
    button{cursor:pointer}
    button#reload{background:#fff;border-color:#111;color:#111;font-weight:600} 
    .quick{max-width:1100px;margin:8px auto 0;padding:0 16px 12px;display:flex;gap:8px;flex-wrap:wrap}
    .tag{cursor:pointer;user-select:none;background:#fff}
    .tag.active{background:#111;color:#fff;border-color:#111;font-weight:600} 
    .tag[data-tag="Nacional"].active{background:var(--hp-orange);border-color:var(--hp-orange);color:#fff}
    .tag[data-tag="Internacional"].active{background:var(--hp-blue);border-color:var(--hp-blue);color:#fff} 
    main{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:#fff;border:1px solid #e6e7ec;border-radius:var(--radius);padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);border-left:4px solid transparent}
    @media (min-width:720px){.card{grid-column:span 6}}
    @media (min-width:1024px){.card{grid-column:span 4}}
    .card.tag-nacional{border-left-color:var(--hp-orange)} 
    .card.tag-internacional{border-left-color:var(--hp-blue)} 
    .title{font-family:Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;font-weight:700;font-size:18px;margin:0 0 6px}
    .title a{color:var(--hp-blue);text-decoration:none}
    .title a:hover{text-decoration:underline}
    .meta{font-size:13px;color:#6b7280;display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #e2e4ea;font-size:12px;color:var(--hp-gray);background:#fff}
    .pill.tag-nacional{background:var(--hp-orange);border-color:var(--hp-orange);color:#fff} 
    .pill.tag-internacional{background:var(--hp-blue);border-color:var(--hp-blue);color:#fff} 
    .desc{margin-top:10px;color:#2b2e34}
    .empty{opacity:.8;text-align:center;padding:32px}
    footer{max-width:1100px;margin:6px auto 24px;color:#6b7280;font-size:12px;text-align:center}
  </style>
  <!-- Day.js for date parsing/formatting -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_customParseFormat)</script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="wrap">
        <h1>Hedgepoint News Feed</h1>
        <div class="controls">
          <input id="search" type="search" placeholder="Buscar… (título, veículo, resumo)" />
          <select id="sort">
            <option value="newest">Mais recentes</option>
            <option value="oldest">Mais antigas</option>
            <option value="az">Título A→Z</option>
            <option value="za">Título Z→A</option>
          </select>
          <button id="reload">Reload</button>
        </div>
      </div>
    </header>

    <div class="quick">
      <span class="tag" data-tag="Nacional">Nacional</span>
      <span class="tag" data-tag="Internacional">Internacional</span>
    </div>

    <div class="controls" style="margin-bottom:12px">
      <span class="tag" data-tag="Nacional">Nacional</span>
      <span class="tag" data-tag="Internacional">Internacional</span>
      <!-- Add more quick-tags if you use other labels in your CSV -->
    </div>

    <main class="grid" id="grid"></main>
    <div id="empty" class="empty" hidden>No results found. Try clearing filters.</div>

    <footer>
      <div>Static site. Data loaded from a CSV file at runtime. Update the CSV and the feed updates automatically.</div>
    </footer>
  </div>

<script>
/**
 * HOW TO DEPLOY (100% FREE):
 * 1) Place this file (index.html) and your CSV (noticias.csv) in the same folder of a public GitHub repo.
 * 2) In GitHub → Settings → Pages → set Build and deployment to main branch (/root). Copy the public URL.
 * 3) To update the feed, edit/add rows in noticias.csv and commit. The site will reflect changes on reload.
 *
 * If you must keep a different CSV filename or host (e.g., Google Sheets "Publish to web" → CSV), just change CSV_URL below.
 * IMPORTANT: If you use SharePoint/OneDrive links, you may hit CORS/auth issues. The safest is keeping the CSV in the same repo.
 */

// === CONFIG ===
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRylZeZ-nRjTQy6KHzcJSp9Wo28KrLFfJKhORvj8_-5Kv1thY9SdjKuXfoXr24FzopqR34Xr-us-_fi/pub?gid=583607882&single=true&output=csv'; // default expects the CSV next to this HTML
const AUTO_REFRESH_MINUTES = 0; // set to >0 to auto-reload (e.g., 5)

// Optional: map common header aliases → canonical keys we use internally
const HEADER_ALIASES = {
  date: ['data','date','published','publish_date','dia'],
  title: ['titulo','título','title','headline'],
  url: ['link','url','href'],
  outlet: ['veiculo','veículo','fonte','outlet','source','publisher'],
  summary: ['resumo','descricao','descrição','summary','description'],
  tag: ['tag','tags','categoria','categoria(s)','label','classificacao','classificação','tipo','nacional/internacional','nacional','internacional']
};

let RAW_ROWS = [];
let ACTIVE_TAGS = new Set();

const $grid = document.getElementById('grid');
const $empty = document.getElementById('empty');
const $search = document.getElementById('search');
const $sort = document.getElementById('sort');
const $reload = document.getElementById('reload');

// Tag toggles
for (const el of document.querySelectorAll('.tag')){
  el.addEventListener('click', () => {
    const t = el.dataset.tag;
    if (ACTIVE_TAGS.has(t)) { ACTIVE_TAGS.delete(t); el.classList.remove('active'); }
    else { ACTIVE_TAGS.add(t); el.classList.add('active'); }
    render();
  });
}

$search.addEventListener('input', () => render());
$sort.addEventListener('change', () => render());
$reload.addEventListener('click', () => fetchCSV(true));

if (AUTO_REFRESH_MINUTES > 0) {
  setInterval(() => fetchCSV(true), AUTO_REFRESH_MINUTES * 60 * 1000);
}

fetchCSV();

function fetchCSV(bustCache=false){
  const url = bustCache ? `${CSV_URL}?t=${Date.now()}` : CSV_URL;
  Papa.parse(url, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      RAW_ROWS = normalizeRows(res.data || []);
      render();
    },
    error: (err) => {
      console.error('CSV load error', err);
      $grid.innerHTML = '';
      $empty.hidden = false;
      $empty.textContent = 'Failed to load CSV. Make sure the file is public.';
    }
  });
}

function normalizeRows(rows){
  const mapKey = (key) => {
    const k = (key||'').trim().toLowerCase();
    for (const canonical in HEADER_ALIASES){
      const list = HEADER_ALIASES[canonical];
      if (list.includes(k)) return canonical;
    }
    return k; // fallback
  };

  if (!rows.length) return [];
  const sample = rows[0];
  const keyMap = {};
  for (const k in sample){ keyMap[k] = mapKey(k); }

  return rows.map(r => {
    const obj = {};
    for (const k in r){ obj[keyMap[k]] = (r[k]||'').toString().trim(); }

    // parse date
    obj.dateParsed = parseDate(obj.date);

    // normalize tags (Nacional/Internacional)
    let tags = (obj.tag||'').split(/[,;|]/).map(s => s.trim()).filter(Boolean);
    if (!tags.length){
      // Fallback: infer from language heuristics (PT => Nacional, outras => Internacional)
      const text = [obj.title, obj.summary, obj.outlet].join(' ');
      tags = [ isPortuguese(text) ? 'Nacional' : 'Internacional' ];
    } else {
      // Canonicalize values
      tags = tags.map(t => {
        const s = t.toLowerCase();
        if (s.includes('nacion')) return 'Nacional';
        if (s.includes('intern')) return 'Internacional';
        return t; 
      });
    }
    obj.tags = tags;

    return obj;
  });
}

function render(){
  const q = ($search.value||'').toLowerCase();

  let list = RAW_ROWS.filter(row => {
    // active tag filter
    if (ACTIVE_TAGS.size){
      const hasTag = (row.tags||[]).some(t => ACTIVE_TAGS.has(t));
      if (!hasTag) return false;
    }
    // text search
    if (q){
      const hay = [row.title,row.outlet,row.summary,(row.tags||[]).join(' ')].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  // Sort
  const s = $sort.value;
  list.sort((a,b) => {
    if (s === 'newest'){
      const ad = a.dateParsed ? a.dateParsed.valueOf() : 0;
      const bd = b.dateParsed ? b.dateParsed.valueOf() : 0;
      return bd - ad;
    }
    if (s === 'oldest'){
      const ad = a.dateParsed ? a.dateParsed.valueOf() : 0;
      const bd = b.dateParsed ? b.dateParsed.valueOf() : 0;
      return ad - bd;
    }
    if (s === 'az') return (a.title||'').localeCompare(b.title||'');
    if (s === 'za') return (b.title||'').localeCompare(a.title||'');
    return 0;
  });

  $grid.innerHTML = '';
  if (!list.length){ $empty.hidden = false; return; }
  $empty.hidden = true;

  for (const row of list){
    const title = row.title || '(untitled)';
    const url = row.url || '#';
    const outlet = row.outlet || '';
    const dateStr = row.dateParsed ? row.dateParsed.format('DD/MM/YYYY') : (row.date || '');
    const summary = row.summary || '';
    const tags = row.tags || [];
    const firstTag = slugify(tags[0]||'');

    const card = document.createElement('article');
    card.className = `card ${firstTag ? 'tag-'+firstTag : ''}`;
    card.innerHTML = `
      <h3 class="title"><a href="${escapeHTML(url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(title)}</a></h3>
      <div class="meta">
        ${dateStr ? `<span class="pill">🗓️ ${escapeHTML(dateStr)}</span>` : ''}
        ${outlet ? `<span class="pill">🏷️ ${escapeHTML(outlet)}</span>` : ''}
        ${tags.map(t => `<span class=\"pill tag-${slugify(t)}\">${escapeHTML(t)}</span>`).join('')}
      </div>
      ${summary ? `<p class="desc">${escapeHTML(summary)}</p>` : ''}
    `;
    $grid.appendChild(card);
  }
}

function slugify(str){
  return (str||'').toString().toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
}

function isPortuguese(text){
  const s = (text||'').toLowerCase();
  // quick diacritics check
  if(/[áâãàéêíóôõúç]/.test(s)) return true;
  // common PT stopwords and prepositions
  const hits = [' de ',' do ',' da ',' dos ',' das ',' para ',' com ',' em ',' por ',' sem ',' sobre ',' entre ',' pelo ',' pela ',' aos ',' às ',' ao ',' à ',' não ',' será ',' foram ',' está ',' também '];
  let score = 0;
  for (const w of hits){ if (s.includes(w)) score++; }
  // simple heuristic threshold
  return score >= 2;
}(str){
  return (str||'').toString().toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
}
}

function escapeHTML(str){
  return (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
}
</script>
</body>
</html>
