<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Repositório de Notícias — Hedgepoint</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --hp-orange:#ED8B00; --hp-blue:#272259; --hp-black:#000000; --hp-white:#FFFFFF;
    --hp-off:#F8F9F7; --hp-gray:#4D4C4D; --radius:8px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--hp-off);color:var(--hp-black);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
  a{color:inherit}
  .wrap{max-width:1100px;margin:48px auto;padding:0 20px;}
  h1{font-weight:700;font-size:28px;margin:0 0 8px;}
  .sub{color:var(--hp-gray);margin:0 0 24px;font-size:14px;}

  .controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:12px;align-items:end;margin:0 0 20px;}
  .control{display:flex;flex-direction:column;gap:6px;}
  .control label{font-size:12px;color:var(--hp-gray)}
  .control select,.control input{border:1px solid #ddd;border-radius:4px;padding:10px 12px;background:#fff;font:inherit;outline:none;}
  .btn{border-radius:4px;padding:10px 16px;background:var(--hp-black);color:#fff;border:none;cursor:pointer;font-weight:700;}

  #container{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  @media (max-width:980px){#container{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:640px){#container{grid-template-columns:1fr;}}

  .card{background:#fff;border:1px solid #eee;border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;display:flex;flex-direction:column;gap:10px;}
  .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .badges{display:flex;gap:8px;align-items:center;min-width:0}
  .badge{font-weight:700;font-size:12px;padding:6px 10px;border-radius:4px;display:inline-flex;align-items:center;letter-spacing:.2px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .badge--nacional{background:var(--hp-orange);color:#fff;}
  .badge--internacional{background:var(--hp-blue);color:#fff;}
  .badge--outline{background:#fff;border:2px solid var(--hp-orange);color:var(--hp-black);}
  .badge--printed{background:#fff;border:2px solid #BDBDBD;color:var(--hp-gray);} /* “Material impresso” */

  .date{font-size:12px;color:var(--hp-gray);white-space:nowrap;}
  .title{font-weight:700;font-size:18px;line-height:1.25;margin:0;}
  .vehicle{display:flex;align-items:center;gap:10px;margin-top:2px;}
  .vehicle img{width:22px;height:22px;border-radius:4px;border:1px solid #eee;object-fit:cover;background:#fff;}
  .vehicle span{font-size:12px;color:var(--hp-gray)}
  .cta{display:flex;justify-content:flex-end;margin-top:auto;}
  .button-link{border:2px solid var(--hp-black);color:#fff;background:var(--hp-black);padding:8px 14px;border-radius:4px;font-weight:700;text-decoration:none;transition:transform .06s ease;}
  .button-link:hover{transform:translateY(-1px);}
  .list-footer{display:flex;justify-content:center;margin:24px 0 8px;}
  .empty{padding:28px;text-align:center;color:var(--hp-gray)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Repositório de Notícias</h1>
    <p id="statsLine" class="sub">Carregando…</p>

    <div class="controls" role="region" aria-label="Filtros">
      <div class="control">
        <label for="escopo">Escopo</label>
        <select id="escopo">
          <option value="">Todos</option>
          <option value="nacional">Nacional</option>
          <option value="internacional">Internacional</option>
        </select>
      </div>
      <div class="control" id="categoriaControl" hidden>
        <label for="categoria">Categoria</label>
        <select id="categoria">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="control">
        <label for="from">De</label>
        <input id="from" type="date">
      </div>
      <div class="control">
        <label for="to">Até</label>
        <input id="to" type="date">
      </div>
      <button id="apply" class="btn">Aplicar filtros</button>
    </div>

    <div id="container"></div>
    <div class="list-footer">
      <button id="loadMore" class="btn">Carregar mais</button>
    </div>
    <div id="emptyState" class="empty" style="display:none">Nenhuma notícia encontrada com os filtros atuais.</div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // mostra erros JS no subtítulo
    window.addEventListener('error', e=>{
      const el=document.getElementById('statsLine');
      if(el) el.textContent='Erro de script: '+(e.message||'desconhecido');
    });
  </script>

  <script>
  (function(){
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Wkg0xuRA_RhRVfyS0azJ80LfzN9Ezm7Xg64J_ebTTm7S3LjmNI8BpqhjOJ-PzyjtCdCeEtfdaFSE/pub?output=csv';

    const FIELD = {
      categoria:'Categoria', titulo:'Titulo', veiculo:'Veiculo',
      data:'DataPublicacao', url:'URL', escopo:'Escopo',
      commodity:'Commodity', logo:'Logo'
    };

    const PAGE_SIZE = 9;
    let master = [], view = [], page = 0, hasCategoria = false;

    const els = {
      container: document.getElementById('container'),
      loadMore: document.getElementById('loadMore'),
      empty: document.getElementById('emptyState'),
      escopo: document.getElementById('escopo'),
      categoria: document.getElementById('categoria'),
      categoriaControl: document.getElementById('categoriaControl'),
      from: document.getElementById('from'),
      to: document.getElementById('to'),
      apply: document.getElementById('apply'),
      stats: document.getElementById('statsLine')
    };

    // ------------ Utils
    function clean(s){
      return String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }
    function titleCasePt(s){
      return String(s||'')
        .toLocaleLowerCase('pt-BR')
        .replace(/([\p{L}\p{M}]+)/gu, w => w.charAt(0).toLocaleUpperCase('pt-BR') + w.slice(1));
    }
    const monthsPt=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

    // parser estrito
    function parseDateFlexible(s){
      if(!s) return null;
      s = String(s).trim();
      const onlyDate = s.replace(/[T\s].*$/,'');
      // YYYY/MM/DD ou YYYY-MM-DD ou YYYY.MM.DD
      let m = onlyDate.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3]);
      // DD/MM/YYYY ou DD-MM-YYYY
      m = onlyDate.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
      if(m){
        const y = m[3].length===2 ? +('20'+m[3]) : +m[3];
        return new Date(y, +m[2]-1, +m[1]);
      }
      return null;
    }
    function formatDatePt(d){
      if(!(d instanceof Date)||isNaN(d)) return '';
      const day=d.getDate(), mon=monthsPt[d.getMonth()], year=d.getFullYear();
      return `${String(day).padStart(2,'0')} ${mon} ${year}`;
    }
    function byDateDesc(a,b){ return (b.__ts||0)-(a.__ts||0); }

    function extractDomain(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{ return ''; } }
    function logoForItem(item){
      if(item.logo) return item.logo.trim();
      const d=extractDomain(item.url||'');
      return d ? `https://www.google.com/s2/favicons?sz=64&domain=${encodeURIComponent(d)}`
               : 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" fill="#ddd"/></svg>');
    }

    // ------------ Normalize each row
    function normalizeRow(r){
      const escRaw = (r[FIELD.escopo]||'');
      const escClean = clean(escRaw);
      let escNorm='';
      if(escClean.startsWith('nac')) escNorm='nacional';
      else if(escClean.startsWith('int')) escNorm='internacional';

      const dt = parseDateFlexible(r[FIELD.data]||'');

      const catRaw = (r[FIELD.categoria] || r[FIELD.commodity] || '').trim();
      const catNorm = clean(catRaw);
      if(catRaw) hasCategoria = true;

      return {
        categoria: catRaw,
        __categoria: catNorm,
        titulo: (r[FIELD.titulo]||'').trim(),
        veiculo: (r[FIELD.veiculo]||'').trim(),
        data: (r[FIELD.data]||'').trim(),
        __date: dt?formatDatePt(dt):'',
        __ts:  dt?dt.getTime():0,
        url: (r[FIELD.url]||'').trim(),             // pode estar vazio
        escopo: (escRaw||'').trim(),
        __esc: escNorm,
        logo: (r[FIELD.logo]||'').trim()
      };
    }

    // ------------ Render
    function renderCard(item){
      const card=document.createElement('div'); card.className='card';

      const top=document.createElement('div'); top.className='top-row';
      const left=document.createElement('div'); left.className='badges';

      const esc=item.__esc||'';
      const escBadge=document.createElement('span');
      escBadge.className='badge '+(esc==='nacional'?'badge--nacional':esc==='internacional'?'badge--internacional':'');
      escBadge.textContent=item.escopo||'—';
      left.appendChild(escBadge);

      if(item.categoria){
        const catBadge=document.createElement('span');
        catBadge.className='badge badge--outline';
        catBadge.textContent=item.categoria;
        left.appendChild(catBadge);
      }

      const date=document.createElement('span'); date.className='date';
      date.textContent=item.__date || item.data || '—';

      top.appendChild(left); top.appendChild(date);

      const title=document.createElement('h5'); title.className='title';
      title.textContent=item.titulo||'Sem título';

      const vehicle=document.createElement('div'); vehicle.className='vehicle';
      const img=document.createElement('img'); img.alt=''; img.src=logoForItem(item);
      img.onerror=function(){ this.onerror=null; this.src='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" fill="#ddd"/></svg>'); };
      const veicSpan=document.createElement('span'); veicSpan.textContent=item.veiculo||'';
      vehicle.appendChild(img); vehicle.appendChild(veicSpan);

      const ctaWrap=document.createElement('div'); ctaWrap.className='cta';

      if(item.url){
        const link=document.createElement('a');
        link.className='button-link';
        link.href=item.url;
        link.target='_blank';
        link.rel='noopener';
        link.textContent='Ver notícia';
        ctaWrap.appendChild(link);
      }else{
        const printed = document.createElement('span');
        printed.className = 'badge badge--printed';
        printed.textContent = 'Material impresso';
        ctaWrap.appendChild(printed);
      }

      card.appendChild(top); card.appendChild(title); card.appendChild(vehicle); card.appendChild(ctaWrap);
      return card;
    }

    // ------------ UI helpers
    function clearGrid(){ els.container.innerHTML=''; }
    function paintNextPage(){
      const start=page*PAGE_SIZE, slice=view.slice(start,start+PAGE_SIZE);
      slice.forEach(i=>els.container.appendChild(renderCard(i)));
      page++; els.loadMore.style.display=(page*PAGE_SIZE)<view.length?'':'none';
      els.empty.style.display=view.length?'none':'';
    }

    // dedup case-insensitive com rótulo bonito
    function buildCategoryOptions(){
      if(!hasCategoria){ els.categoriaControl.hidden=true; return; }
      const map=Object.create(null);
      master.forEach(r=>{
        if(!r.categoria) return;
        const key=r.__categoria; if(!key) return;
        if(!map[key]) map[key]=r.categoria;
      });
      Object.keys(map).forEach(k=> map[k]=titleCasePt(map[k]));
      const keys=Object.keys(map).sort((a,b)=> map[a].localeCompare(map[b],'pt-BR'));
      let html='<option value="">Todas</option>';
      keys.forEach(k=> html+=`<option value="${k}">${map[k]}</option>`);
      els.categoria.innerHTML=html;
      els.categoriaControl.hidden=false;
    }

    function isFiltering(){
      const esc=clean(els.escopo.value);
      const cat=hasCategoria?els.categoria.value:'';
      const from=els.from.value?Date.parse(els.from.value+'T00:00:00'):null;
      const to  =els.to.value?Date.parse(els.to.value+'T23:59:59'):null;
      return !!(esc||cat||from||to);
    }
    function plural(n,sing,plur){ return n===1?sing:plur; }
    function updateStats(){
      const total=master.length, current=view.length;
      els.stats.textContent = isFiltering()
        ? `Mostrando ${current} ${plural(current,'matéria','matérias')} de ${total} ${plural(total,'menção','menções')}.`
        : `Total de ${total} ${plural(total,'menção','menções')}.`;
    }

    function applyFilters(){
      const escopoVal=clean(els.escopo.value);
      const catKey=hasCategoria?els.categoria.value:'';
      const fromTs=els.from.value?Date.parse(els.from.value+'T00:00:00'):null;
      const toTs  =els.to.value?Date.parse(els.to.value+'T23:59:59'):null;

      view = master.filter(r=>{
        const okEsc = !escopoVal || r.__esc === escopoVal;
        const okCat = !hasCategoria || !catKey || r.__categoria === catKey;

        let okDate = true;
        if(fromTs !== null) okDate = okDate && (r.__ts && r.__ts >= fromTs);
        if(toTs   !== null) okDate = okDate && (r.__ts && r.__ts <= toTs);

        return okEsc && okCat && okDate;
      }).sort(byDateDesc);

      page=0; clearGrid(); paintNextPage(); updateStats();
    }

    els.apply.addEventListener('click', applyFilters);
    els.loadMore.addEventListener('click', paintNextPage);

    // ------------ Boot
    function loadCSV(){
      if(!window.Papa){ els.stats.textContent='Erro: biblioteca de leitura (PapaParse) não carregou.'; return; }
      Papa.parse(CSV_URL,{
        download:true, header:true, skipEmptyLines:true,
        complete: res=>{
          try{
            hasCategoria=false;
            const rows=res.data||[];
            // agora NÃO exigimos URL; só título
            master = rows.map(normalizeRow).filter(r=> r.titulo);
            master.sort(byDateDesc);
            buildCategoryOptions();
            applyFilters();
          }catch(err){
            console.error('Falha ao processar CSV:',err);
            els.stats.textContent='Falha ao processar CSV.';
          }
        },
        error: err=>{
          console.error('Erro CSV:',err);
          els.stats.textContent='Erro ao baixar o CSV publicado.';
        }
      });
    }
    window.addEventListener('load', loadCSV);
  })();
  </script>
</body>
</html>
